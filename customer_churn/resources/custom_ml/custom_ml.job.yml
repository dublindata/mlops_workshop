resources:
  jobs:
    custom_ml:
      name: Custom ML - Customer Churn ML Model
      tasks:
        - task_key: train_model
          notebook_task:
            notebook_path: ../../training/notebooks/custom_model_training.py
            source: WORKSPACE
          job_cluster_key: training_cluster

        - task_key: validation
          notebook_task:
            notebook_path: ../../validation/notebooks/validation.py
            source: WORKSPACE
          depends_on:
            - task_key: train_model
          job_cluster_key: training_cluster

        - task_key: challenger_champion
          notebook_task:
            notebook_path: ../../validation/notebooks/challenger_champion.py
            source: WORKSPACE
          depends_on:
            - task_key: validation
              
        - task_key: new_champion_conditional
          condition_task:
            op: EQUAL_TO
            left: "{{tasks.custom_ml.values.new_champion}}"
            right: "true"
          depends_on: 
            - task_key: challenger_champion
              
        - task_key: update_mms_endpoint 
          notebook_task:
            notebook_path: ../../deployment/model_deployment/mosaic_model_serving.ipynb
            source: WORKSPACE
            base_parameters:
              endpoint_name: ${var.endpoint_name}
              short_model_name: ${var.short_model_name}
          depends_on:
            - task_key: new_champion_conditional
              outcome: "true"
          

      job_clusters:
        - job_cluster_key: training_cluster
          new_cluster:
            spark_version: 15.4.x-scala2.12
            aws_attributes:
              availability: SPOT_WITH_FALLBACK
            node_type_id: r6id.xlarge
            spark_env_vars:
              PYSPARK_PYTHON: /databricks/python3/bin/python3
            data_security_mode: DATA_SECURITY_MODE_DEDICATED
            runtime_engine: PHOTON
            kind: CLASSIC_PREVIEW
            use_ml_runtime: true
            is_single_node: false
            autoscale:
              min_workers: 2
              max_workers: 8

      queue:
        enabled: true

      parameters:
        - name: catalog_use
          default: ${var.catalog_use}
        - name: schema_use
          default: ${var.schema_use}
        - name: inference_table_name
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_inference_table
        - name: advanced_churn_label_table
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_label_table
        - name: advanced_churn_feature_table
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_feature_table
        - name: avg_price_increase
          default: ${var.catalog_use}.${var.schema_use}.avg_price_increase
        - name: model_alias
          default: challenger
        - name: model_info_table
          default: ${var.catalog_use}.${var.schema_use}.model_info_table
