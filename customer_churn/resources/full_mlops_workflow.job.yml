resources:
  jobs:
    full_mlops_workflow:
      name: Customer Churn Full MLOps Workflow
      tasks:
        - task_key: first_run_conditional
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.first_run}}"
            right: "true"

        - task_key: data_preparation
          run_job_task:
            job_id: ${resources.jobs.data_preparation.id}
          depends_on:
            - task_key: first_run_conditional
              outcome: "true"

        - task_key: auto_ml
          run_job_task:
            job_id: ${resources.jobs.auto_ml_baseline.id}
          depends_on:
            - task_key: data_preparation

        - task_key: custom_ml
          run_job_task:
            job_id: ${resources.jobs.custom_ml.id}
          depends_on:
            - task_key: auto_ml
            - task_key: first_run_conditional
              outcome: "false"
          run_if: AT_LEAST_ONE_SUCCESS



      # job_clusters:
      #   - job_cluster_key: training_cluster
      #     new_cluster:
      #       spark_version: 15.4.x-scala2.12
      #       aws_attributes:
      #         availability: ON_DEMAND
      #       node_type_id: rd-fleet.xlarge
      #       spark_env_vars:
      #         PYSPARK_PYTHON: /databricks/python3/bin/python3
      #       data_security_mode: DATA_SECURITY_MODE_DEDICATED
      #       runtime_engine: PHOTON
      #       kind: CLASSIC_PREVIEW
      #       use_ml_runtime: true
      #       is_single_node: false
      #       autoscale:
      #         min_workers: 2
      #         max_workers: 8
            
          
      queue:
        enabled: true
      parameters:
        - name: catalog_use
          default: ${var.catalog_use}
        - name: schema_use
          default: ${var.schema_use}
        - name: bronze_table_name
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_bronze_customers
        - name: inference_table_name
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_inference_table
        - name: input_table_name
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_bronze_customers
        - name: advanced_churn_label_table
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_label_table
        - name: advanced_churn_feature_table
          default: ${var.catalog_use}.${var.schema_use}.advanced_churn_feature_table
        - name: avg_price_increase
          default: ${var.catalog_use}.${var.schema_use}.avg_price_increase
        - name: model_timeout_minutes
          default: ${var.model_timeout_minutes}
        - name: model_info_table
          default: ${var.catalog_use}.${var.schema_use}.model_info_table
        - name: first_run
          default: false
        - name: short_model_name 
          default: ${var.model_name}